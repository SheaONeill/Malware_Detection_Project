#!/bin/bash 
#
#check results
#
#

menu () {
#clear
while true ;do
    #clear
    show_results 
    echo -e "\nScan Results Menu"
    echo -e "---------------------------"
     echo -e "\nPlease Choose an Option"
	CHOICES="display_malware display_benign display_unrecognized clear_logs show_quarantined_files quit"
	select choice in $CHOICES
	
	  do 
	    case $choice in
          display_malware)
		display_malware
		;;
	      display_benign)
	      display_benign 
		;;
	      display_unrecognized)
	      find_unrecognized
	      display_unrecognized
		;;
		clear_logs)
	      clear_logs
	      #return to main menu
	      $(dirname "${0}")/setup.sh
	    ;;
	    show_quarantined_files)
	      show_quarantined_files
	      #return to main menu
	    ;;
	      quit)
		$(dirname "${0}")/setup.sh
		;;	
		*) 
		echo -e "\nInvalid Choice!"
	    ;;
	    esac
	    break;
          done	;
done;
	}


show_results () {
    echo -e "-------------------------------------------" 
       #set colour to red,bold
        echo -n "$(tput setaf 1)"
        echo -n "$(tput bold)"
    
    #use grep and word cound to find totals    
    echo $(grep  -o "ID"  ${LOG_DIR}/found_malware.log | wc -l) "Malware found"      
        #set colour to green,bold
        echo -n "$(tput setaf 2)"
        echo -n "$(tput bold)"
        
    echo $(grep  "ID"  ${LOG_DIR}/benign.log | wc -l) "Benign found"
        #call find_unrecognized function
        find_unrecognized    
        #set colour to 
        echo -n "$(tput setaf 3)"
        echo -n "$(tput bold)"   
             
    #use word count to display unknown hahses (this way omits showing file name)
    echo $(wc -l < ${LOG_DIR}/unrecognized_hashes.log) "Unrecognized"  
        #reset colour
        echo -n "$(tput sgr0)"
        echo -e "-------------------------------------------\n"       
        if [[ "$menu_choice" == "scan_file" ]]
        then
            echo -e "-------------------------------------------" 
            echo -e "Matched Strings"
            grep -wFf ${ABSOLUTE_PATH}/strings.lst ${LOG_DIR}/strings.log
            echo -e "-------------------------------------------\n" 
    
         fi
         #reset colour
         echo -n "$(tput sgr0)"
}

display_malware () {
        #reset colour
        echo "$(tput sgr0)"
        #set colour to red,bold
        echo "$(tput setaf 1)"
        echo "$(tput bold)"
        echo -e "\n-------------------------------------------"
        echo $(grep  -o "ID"  ${LOG_DIR}/found_malware.log | wc -l) "Malware Hashes Found"   
        cat ${LOG_DIR}/found_malware.log
        echo -e "-------------------------------------------"   
        #reset colour
        echo "$(tput sgr0)"
       
       #move to quarantine
       echo -e "\n(Note for this demo only using cp not mv so originals are intact for testing)"
       read -p "Move to Quarantine? (Yy) " -n 1 -r
       if [[ $REPLY =~ ^[Yy]$ ]];then        
            if [ ${menu_choice} == "scan_file" ];then
                echo "$(grep -f ${LOG_DIR}/found_malware_hashes.log ${LOG_DIR}/hash.log | cut -d' ' -f2)" > ${LOG_DIR}/quarantine.log
                echo "Moving to ${QUARINTINE}"
                #cat ${LOG_DIR}/quarantine.log
                while read file; do cp  "${file}" ${QUARINTINE} ; done < ${LOG_DIR}/quarantine.log
                echo -e "\nMove Completed Show Quarantined for more options!";
                sleep 2
            else echo "$(grep -f ${LOG_DIR}/found_malware_hashes.log ${LOG_DIR}/hash.log | cut -d' ' -f3)"> ${LOG_DIR}/quarantine.log
                echo "Moving to ${QUARINTINE}"
                #cat ${LOG_DIR}/quarantine.log
                while read file; do cp  "${file}" ${QUARINTINE} ; done < ${LOG_DIR}/quarantine.log
                echo -e "\nMove Completed Show Quarantined for more options!";
                sleep 2
                
            fi
        fi
        
        sleep 3
        clear
}
        
display_benign () {     
        clear 
        #set colour to green,bold
        echo "$(tput setaf 2)"
        echo "$(tput bold)"
        echo -e "\n-------------------------------------------"           
        echo $(grep  "ID"  ${LOG_DIR}/benign.log | wc -l) "Benign Hashes Found"
        cat ${LOG_DIR}/benign.log
        echo -e "-------------------------------------------"   
        #reset colour
        echo "$(tput sgr0)"
        read -p "Press any key to continue" -n 1 -r
        clear
}
 
find_unrecognized () { 
        #find hashes from hash log not in found found_malware_hahses.log and output to unrecognized_hahses.log
        grep -v -f ${LOG_DIR}/found_malware_hashes.log ${LOG_DIR}/hash.log > ${LOG_DIR}/temp_unrecognized_hashes.log
        #find hashes from unrecognized_hashes.log not in found fbenign.log_hahses.log and output to unrecognized_hahses.log
        grep -v -f ${LOG_DIR}/benign_hashes.log ${LOG_DIR}/temp_unrecognized_hashes.log > ${LOG_DIR}/unrecognized_hashes.log
        #cut pathnames for fuzzy hashing
        if [ ${menu_choice} == "scan_file" ];then
                echo $(cut -d ' ' -f2 ${LOG_DIR}/unrecognized_hashes.log) > ${LOG_DIR}/unrecognized_hashes_paths.log  
        else
               echo $(cut -d ' ' -f3 ${LOG_DIR}/unrecognized_hashes.log) > ${LOG_DIR}/unrecognized_hashes_paths.log  
        fi
}
        
display_unrecognized () {        
        #todo format these results for better display
        #set colour to 
        echo "$(tput setaf 3)"
        echo "$(tput bold)"
        #todo check these with ssdeep
        echo -e "\n-------------------------------------------"   
         echo $(wc -l < ${LOG_DIR}/unrecognized_hashes.log) "Unrecognized Hashes Found"
        cat ${LOG_DIR}/unrecognized_hashes.log
        echo -e "\n-------------------------------------------"   
        #reset colour
        echo "$(tput sgr0)"
        #suggest ssdeep chek
        read -p "Check Files with fuzzy hashing? (Yy) " -n 1 -r
            if [[ $REPLY =~ ^[Yy]$ ]];then  
                $(dirname "${0}")/ssdeep.sh
             sleep 1;
             clear
            fi
        #reset colour
        echo "$(tput sgr0)"
        #read -p "Press any key to continue" -n 1 -r
        clear
}

clear_logs () {
    #echo "In clear logs"
    log_dir=${LOG_DIR}
    #remove al logs
    rm ${LOG_DIR}/*
    #reset colour
    echo "$(tput sgr0)"
}

show_quarantined_files () {
    echo
    #check if quarantine dir is empty
    if [ -z "$(ls -A ${QUARINTINE})" ];then    
         echo "No Quarantined Files Found!"
         sleep 1;
         clear
     else       
        #reset colour
        echo "$(tput sgr0)"
        #set colour to red,bold
        echo "$(tput setaf 1)"
        echo "$(tput bold)"    
        ls ${QUARINTINE}
        #reset colour
        echo "$(tput sgr0)"
         #delete from quarantine
        read -p "Delete Quarantined files? (Yy) " -n 1 -r
            if [[ $REPLY =~ ^[Yy]$ ]];then  
                rm ${QUARINTINE}/*
                clear
                echo "Files Deleted"
             sleep 1;
             clear
            fi
     fi
}
menu     
