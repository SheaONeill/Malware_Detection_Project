#!/bin/bash

main () {
	 	
	#ref: http://stackoverflow.com/questions/4774054/reliable-way-for-a-bash-script-to-get-the-full-path-to-itself
	#set and export envoirnment vars
	export ABSOLUTE_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
	export QUARINTINE=${ABSOLUTE_PATH}/quarantine/
	export LOG_DIR=${ABSOLUTE_PATH}/log
	echo "LOG_DIR ${LOG_DIR}"
	clear
	#call copy_files function
	copy_files
	#call ssdeep_check
	ssdeep_check
	#call menu function
	menu
	exit 0	
	}

menu () {
    while true; do
        clear
        echo -e "\nMain Menu"
        echo -e "---------"
        echo -e "\nPlease Choose an Option"
	    MENU_CHOICES="setup_database scan_file scan_directory quit"
	    select menu_choice in $MENU_CHOICES
	
	      do 
	        case $menu_choice in
                  setup_database)
		            setup_db
		            ;;
	             scan_file)
	                export menu_choice
		            $(dirname "${0}")/file_to_check_function.sh 
		            $(dirname "${0}")/check_results.sh
		            ;;
	            scan_directory)
	                export menu_choice
		            $(dirname "${0}")/dir_to_check_function.sh
		            $(dirname "${0}")/check_results.sh
		            ;;
	            quit)
	                exit ;
		            ;;	
		        *) 
		            echo -e "\nInvalid Choice!"
	                ;;
	        esac
	        break;              
         done	;
    done
}

#ssdeep_check
ssdeep_check () {
	#echo -e "\nIn ssdeep check"
	which_ssdeep=`which ssdeep`
	   if [ -z "$which_ssdeep" ];
	     then echo "not found"
                #get_ssdeep=`apt-get update && apt-get install ssdeep`
             	gnome-terminal -e 'bash -c "sudo apt-get update && apt-get install ssdeep"' & wait $! 
	     	echo "${which_ssdeep}"
	     else
	        echo "found ssdeep"
	        echo "${which_ssdeep}"
	   fi
		}
#copy files functions
copy_files () {
    #TODO chmod the scripts needed
    #create empty default log files
    touch ${LOG_DIR}/found_malware.log ${LOG_DIR}/found_malware_hashes.log ${LOG_DIR}/benign.log  ${LOG_DIR}/benign_hashes.log ${LOG_DIR}/unrecognized_hashes.log
    #create file headers for ssdeep logs
	echo -e "ssdeep,1.1--blocksize:hash:hash,filename" > ${LOG_DIR}/ssdeep_benign_hashes.log && echo -e "ssdeep,1.1--blocksize:hash:hash,filename" > ${LOG_DIR}/ssdeep_malware_hashes.log
	
	#make scripts exectable
	#echo ${ABSOLUTE_PATH}
	#chmod +x ${ABSOLUTE_PATH}/*
	
}

#-------- begin setup database functions --------
#setup database function
setup_db () {
    #call get_db_details
    get_db_details
    #setup database call dbsetup script and pass values
    $(dirname "${0}")/dbsetup $host $dbname $name $pass
	}

#get user input
get_db_details () {        
    	echo -n "database host: "
    	#todo if user enters nothing use localhost as default
    	read host
    	echo -en "database name: "
    	read dbname
    	echo -en "username: "
    	#todo if user enters nothing use localhost as default
    	read name
    	echo -en "password: "
	read pass    
	}
#-------- end get_db_details function --------

main "$@"

