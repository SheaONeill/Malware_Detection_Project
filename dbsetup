#!/bin/bash

echo "Usage:dbhost dbname dbuser dbpass"
echo "test" $# $1 $2 $3 $4

setup_vars () {
	#setup vars  
	ARGS=4
	ERR_CODE=65
	#db vars	
	MYSQL=`which mysql`
	CDB="CREATE DATABASE $2;"
	GU1="GRANT USAGE ON $2.* TO $3@$1 IDENTIFIED BY '$4';"
	GU2="GRANT ALL PRIVILEGES ON $2.* TO $3@$1;"
	FPS="FLUSH PRIVILEGES;"
	VFY="SHOW DATABASES;"
	UDB="USE $2;"
echo "test_setup_vars" $# $1 $2 $3 $4
}


query_var () {
	#query var
	if [ $3 != "root" ];
	then
	echo "query_var is not root" $# $1 $2 $3 $4
	SQL="${CDB}${GU1}${GU2}${FPS}${VFY}${UDB}${CWT}${IWT}${CBK}${IBK}"
        else
	echo "query_var is root " $# $1 $2 $3 $4 ${VFY} ${UDB} ${CWT} ${IWT} ${CBK} ${IBK}
	SQL="${CDB}${VFY}${UDB}${CWT}${IWT}${CBK}${IBK}";
        fi
}

create_table () { 
CWT="CREATE TABLE IF NOT EXISTS whitelist(
	id INT AUTO_INCREMENT PRIMARY KEY,
	    	name VARCHAR(30),
	    	md5 VARCHAR(32),
	    	ssdeep VARCHAR(255)
	    	type VARCHAR(15),
	    	released DATE
	    	);"

CBK="CREATE TABLE IF NOT EXISTS blacklist(
	id INT AUTO_INCREMENT PRIMARY KEY,
	    	name VARCHAR(30),
	    	md5 VARCHAR(32),
	    	ssdeep VARCHAR(255)
	    	type VARCHAR(15),
	    	released DATE
	    	);"
	}
	

#insert into table
insert_into_table () {

IBK="INSERT INTO blacklist
	    	(name,md5,ssdeep,type,released) VALUES 
		('UNZIP.EXE', 'dfa534dd64d9783ab688e9febc76f1ae','6144:oJ69/zQ0nR6xV2VALOZyehp8FHJHoeAPCFwYluK:H9/88R6xV2VALOZyehp8lJHokFwxK', 'Trojan', '2009-04-20'),
            	('Virus.Win32.1.a', '68df38b654f79ac7355c5d0d2f909138', '49152:OQ8PjlyQZUUuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuIuuuuuuuuuuuuuuuuuur:18PBBZuuuuuuuuuuuuuuuuuuuuuuuuuc','Trojan', '2001-04-10'),
	    	('Virus.Win32.2.aaa', '2a480f28394b06373b88aad510a3ed2d','48:OEPqeXaO0OnQ/XyDneaZjXQ5QCgTNt63AIhOrYGAwERcEBkX:nPJXazB/XybVZbjC0tQ+rYf9', 'Trojan', '2009-03-27');"

IWT="INSERT INTO whitelist 
    		(name,md5,ssdeep,type,released) VALUES 
		('free-hex-editor-neo.exe', '4e84e10448da4f5455c7824c9a4abd91','393216:kGKdGZlhAVLRiUWIjSZ7/RSXwkLkY1UFlvQB9Yu0:Y43+lRiUFSZ7/RSXwkLGF6B910', 'benign', '2009-04-20'),
    		('PEview.exe', 'ec63e8be0717bd92c0ffbf7a21749a54','1536:j1G+oinWc8W6+DiLoXRxET/t756jDslnY8fURUIjc0dK6yP7zc7XrB:jpoinzKNgD5R1yDKrB', 'benign', '2003-01-15'),
    	        ('Wireshark-win64-2.0.3.exe', '396528535ad0b3848049c5da374b647c','786432:fSM8E+ruf/AFK0c8JbK9l2F9V8hi1IOH9Q7gXQ8pu4bYckWJgJ5Xz1KGeFguOk8k:fSMf0uw1Jm9l2PV8NNgXxp6c8mFguJ', 'benign', '2009-03-27');"
	}

#test if i need filenames and path for fuzzy hashes
#

check_arguments () {
	#check if all arguments are satisfied  
	if [ $# -ne $ARGS ] 
  		then echo "Usage: $# $dbhost $dbname $dbuser $dbpass arguments are not satisfied"
  		exit $ERR_CODE
	else
	echo -e "\nall arguments are satisfied"
	fi
	}

connect_and_query () { 
	$MYSQL -u $3 -p$4 -e "$SQL"
	echo "connect_and_query" $# $1 $2 $3 $4 $5 
	}

main () {
     	setup_vars $1 $2 $3 $4
     	check_arguments $1 $2 $3 $4
	create_table
	insert_into_table
	query_var  $1 $2 $3 $4 $CDB $GU1 $GU2 $FPS $VFY $UDB $CWT $IWT $CBK $IBK
	connect_and_query  $1 $2 $3 $4 $SQL 
	echo -e "\nDatabase setup completed" 
	exit 0	
	}

main "$@"
